import sqlite3
import telebot

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª
API_TOKEN = '7679813979:AAGWex1J2x6mIabmBgKMXGhGuILrPN2wLGo'
bot = telebot.TeleBot(API_TOKEN)

# Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def create_database():
    try:
        conn = sqlite3.connect('chess_game.db')
        cursor = conn.cursor()

        cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            date_joined TEXT DEFAULT CURRENT_TIMESTAMP,
            points INTEGER DEFAULT 0
        )
        ''')

        conn.commit()
    except sqlite3.Error as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
    finally:
        conn.close()

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
def add_new_user(user_id, username, first_name, last_name):
    try:
        conn = sqlite3.connect('chess_game.db')
        cursor = conn.cursor()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        username = username if username else "Unknown"
        first_name = first_name if first_name else "Guest"
        last_name = last_name if last_name else ""

        cursor.execute('''
        INSERT OR IGNORE INTO users (user_id, username, first_name, last_name, date_joined, points)
        VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, 5)
        ''', (user_id, username, first_name, last_name))

        # Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø© Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        print(f"âœ”ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {username} ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")

        conn.commit()
    except sqlite3.Error as e:
        print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
    finally:
        conn.close()

# ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
def update_user_points(user_id, points):
    try:
        conn = sqlite3.connect('chess_game.db')
        cursor = conn.cursor()

        cursor.execute('''
        UPDATE users
        SET points = ?
        WHERE user_id = ?
        ''', (points, user_id))

        conn.commit()
    except sqlite3.Error as e:
        print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·: {e}")
    finally:
        conn.close()

# Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
def get_user_data(user_id):
    try:
        conn = sqlite3.connect('chess_game.db')
        cursor = conn.cursor()

        cursor.execute('SELECT username, first_name, last_name, points FROM users WHERE user_id = ?', (user_id,))
        user_data = cursor.fetchone()

        conn.close()

        if user_data:
            return {
                'username': user_data[0],
                'first_name': user_data[1],
                'last_name': user_data[2],
                'points': user_data[3]
            }
        else:
            return None  # Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯

    except sqlite3.Error as e:
        print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
        return None

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡ /start
@bot.message_handler(commands=['start'])
def handle_start(message):
    user_id = message.from_user.id
    username = message.from_user.username
    first_name = message.from_user.first_name
    last_name = message.from_user.last_name

    print(f"ğŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† {user_id}, {username}, {first_name}, {last_name})")
    add_new_user(user_id, username, first_name, last_name)
    bot.reply_to(message, f"ğŸ‰ Ø£Ù‡Ù„Ø§Ù‹ {first_name}! ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ 5 Ù†Ù‚Ø§Ø·.")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
if __name__ == "__main__":
    create_database()
    print("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
    bot.polling(none_stop=True, interval=0)
